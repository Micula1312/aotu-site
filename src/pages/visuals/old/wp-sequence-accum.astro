---
import Layout from '../../layouts/VisualsLayout.astro';

const title = 'Visuals â€” WP Sequence (Accum, Shuffle)';
const current = 'visuals-seq';
---

<Layout {title} {current}>
  <style slot="head">
    /* DIGITAL LOOK */
    html, body { margin:0; height:100%; background:#000; color:#00ffc8; }
    body { overflow:hidden; font:12px ui-monospace,Menlo,Consolas,monospace; }
    .stage { position:fixed; inset:0; background:#000 radial-gradient(1200px 800px at 10% 5%, rgba(0,255,200,.05), transparent 60%); }
    .stage::before{
      content:""; position:absolute; inset:0; pointer-events:none; opacity:.07;
      background:
        linear-gradient(transparent 31px, #0ff 0) 0 0/100% 32px,
        linear-gradient(90deg, transparent 31px, #0ff 0) 0 0/32px 100%;
    }

    /* wrapper assoluto + img dentro */
    .shot { position:absolute; will-change: left, top, transform; }
    .shot > img.vimg {
      display:block;
      width:var(--wpx); height:var(--hpx);
      object-fit:contain;
      filter:blur(var(--fx-blur));
      max-width:96vw; max-height:96vh; /* ulteriore safety */
    }

    /* PIXELATE reale (serve anche il patch in visuals-fx.css) */
    .fx-pixelate .shot { transform: scale(calc(1 / var(--fx-px))); transform-origin: top left; }
    .fx-pixelate .shot > img.vimg { transform: scale(var(--fx-px)); transform-origin: top left; image-rendering: pixelated; }

    .loading { position:fixed; left:12px; bottom:42px; color:#00ffc8; opacity:.75 }
    .hud {
      position:fixed; left:12px; right:12px; bottom:8px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
      color:#00ffc8; text-shadow:0 0 8px rgba(0,255,200,.35); pointer-events:none;
    }
    .hud .pill { pointer-events:auto; padding:6px 10px; border:1px solid rgba(0,255,200,.35); border-radius:999px; background:rgba(0,0,0,.45); }
    :is(:fullscreen, :-webkit-full-screen) .hud { opacity:0; pointer-events:none; }

    /* immagini sotto ai pannelli UI */
    .stage, .shot, .shot > img { z-index:0; }
  </style>

  <div id="stage" class="stage" aria-live="polite"></div>
  <div id="loading" class="loading">Loadingâ€¦</div>

  <!-- HUD -->
  <div class="hud">
    <span class="pill">F / dbl-click: fullscreen</span>
    <span class="pill">Space: pausa/riprendi</span>
    <span class="pill">R: reshuffle</span>
    <span class="pill">C: clear</span>
    <span class="pill">+ / âˆ’: velocitÃ </span>
    <span class="pill">[ / ]: dimensione</span>
    <span class="pill" id="hudStat">seq â€”</span>
  </div>

  <script type="module">
    // ---------------- params ----------------
    const P = new URLSearchParams(location.search);
    const site    = (P.get('site') || 'https://thearchiveoftheuntamed.xyz/wp').replace(/\/$/, '');
    const perPage = Math.max(1, parseInt(P.get('perPage') || '60', 10));
    const orderby = P.get('orderby') || 'date';
    const order   = P.get('order')   || 'desc';
    const search  = P.get('search')  || '';
    const seed    = Math.max(0, parseInt(P.get('seed') || '6', 10));
    let   every   = Math.max(200, parseInt(P.get('every') || '1200', 10));
    let   SCALE   = Math.min(1, Math.max(0.10, parseFloat(P.get('scale') || '0.30'))); // ðŸ‘ˆ default piÃ¹ piccolo (30%)
    const nMax    = Math.max(1, parseInt(P.get('max') || '120', 10));

    // ---------------- dom -------------------
    const stage   = document.getElementById('stage');
    const loading = document.getElementById('loading');
    const hudStat = document.getElementById('hudStat');

    // ---------------- helpers ---------------
    const ep = new URL(site + '/wp-json/wp/v2/media');
    ep.searchParams.set('per_page', String(perPage));
    ep.searchParams.set('orderby', orderby);
    ep.searchParams.set('order',   order);
    ep.searchParams.set('media_type', 'image');
    ep.searchParams.set('_fields', 'id,source_url,media_details,alt_text');
    if (search) ep.searchParams.set('search', search);
    console.debug('[WP API]', ep.toString());

    const shuffle = (a) => { for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

    // calcola dimensioni coerenti con viewport e scala scelta
    function computeSize(nw, nh){
      const maxW = Math.max(160, Math.floor(innerWidth  * SCALE));
      const maxH = Math.max(160, Math.floor(innerHeight * SCALE));
      const ratio = Math.min(maxW / nw, maxH / nh, 1);
      return { w: Math.round(nw * ratio), h: Math.round(nh * ratio) };
    }

    // posiziona una immagine
    function place(it){
      const natW = (it.media_details && it.media_details.width)  || 1024;
      const natH = (it.media_details && it.media_details.height) || 768;
      const { w, h } = computeSize(natW, natH);

      // evita taglio ai bordi
      const x = Math.floor(Math.random() * Math.max(1, innerWidth  - w));
      const y = Math.floor(Math.random() * Math.max(1, innerHeight - h));

      const wrap = document.createElement('div');
      wrap.className = 'shot';
      wrap.style.left = x + 'px';
      wrap.style.top  = y + 'px';
      wrap.style.setProperty('--wpx', w+'px');
      wrap.style.setProperty('--hpx', h+'px');
      // salva dimensioni naturali per adattamento successivo
      wrap.dataset.nw = String(natW);
      wrap.dataset.nh = String(natH);

      const img = new Image();
      img.className = 'vimg';
      img.decoding = 'async';
      img.loading  = 'eager';
      img.alt = it.alt_text || '';
      img.src = it.source_url;

      wrap.appendChild(img);
      stage && stage.appendChild(wrap);

      if (stage && stage.children.length > nMax) stage.removeChild(stage.firstElementChild);
    }

    // adatta tutte le immagini giÃ  in pagina (resize / cambio SCALE)
    function refitAll(){
      if (!stage) return;
      const shots = stage.children;
      for (const el of shots){
        const wrap = /** @type {HTMLElement} */(el);
        const nw = parseInt(wrap.dataset.nw || '1024', 10);
        const nh = parseInt(wrap.dataset.nh || '768', 10);
        const { w, h } = computeSize(nw, nh);
        wrap.style.setProperty('--wpx', w+'px');
        wrap.style.setProperty('--hpx', h+'px');

        // ricompatta dentro viewport se necessario
        const curX = parseInt(wrap.style.left || '0', 10);
        const curY = parseInt(wrap.style.top  || '0', 10);
        const maxX = Math.max(0, innerWidth  - w);
        const maxY = Math.max(0, innerHeight - h);
        const nx = Math.min(Math.max(0, curX), maxX);
        const ny = Math.min(Math.max(0, curY), maxY);
        if (nx !== curX) wrap.style.left = nx + 'px';
        if (ny !== curY) wrap.style.top  = ny + 'px';
      }
    }

    // Fullscreen (F, ESC, doppio click)
    const fsEl = () => document.fullscreenElement || document.webkitFullscreenElement;
    const enterFS = async (el) => { (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen)?.call(el); };
    const exitFS  = async ()    => { (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen)?.call(document); };
    const toggleFS= () => { const t = stage || document.documentElement; if (!fsEl()) enterFS(t); else exitFS(); };
    stage?.addEventListener('dblclick', (e) => { if (e.target && stage.contains(e.target)) toggleFS(); });

    // ---------------- logic -----------------
    fetch(ep.toString(), { cache:'no-store' })
      .then(r => { if(!r.ok) throw new Error('WP ' + r.status); return r.json(); })
      .then(items => {
        if (!Array.isArray(items) || items.length === 0) throw new Error('Nessuna immagine');
        let firstPlaced = false;
        const onFirst = () => { if (!firstPlaced) { firstPlaced = true; loading?.remove(); } };

        let seq = shuffle(items.slice());
        let idx = 0;

        // seed iniziale
        for (let k=0; k<Math.max(0, Math.min(20, seed)); k++) { place(seq[idx % seq.length]); idx++; }
        onFirst();

        // ciclo
        let paused = false, timer = null;
        const step = () => {
          if (paused) return;
          place(seq[idx % seq.length]); idx++;
          hudStat && (hudStat.textContent = `seq ${(idx % seq.length) || seq.length}/${seq.length} Â· every ${every}ms Â· scale ${(SCALE*100)|0}%`);
        };
        const play = () => { stop(); timer = setInterval(step, every); };
        const stop = () => { if (timer) clearInterval(timer); timer = null; };
        play();

        // controls
        addEventListener('keydown', (e)=>{
          if (e.repeat) return;
          const k = e.key;
          if (k === ' ') { paused = !paused; if (paused) stop(); else { step(); play(); } }
          else if (k === 'r' || k === 'R') { seq = shuffle(items.slice()); idx = 0; }
          else if (k === 'c' || k === 'C') { if (stage) stage.innerHTML = ''; }
          else if (k === '+') { every = Math.max(100, every - 100); play(); }
          else if (k === '-') { every = every + 100; play(); }
          else if (k === '[') { SCALE = Math.max(0.10, +(SCALE - 0.05).toFixed(2)); refitAll(); }
          else if (k === ']') { SCALE = Math.min(1.00, +(SCALE + 0.05).toFixed(2)); refitAll(); }
          else if (k === 'f' || k === 'F') { toggleFS(); }
          else if (k === 'Escape') { if (fsEl()) exitFS(); }
        });

        // adatta quando cambia la viewport (FS on/off, resize)
        addEventListener('resize', refitAll);
        document.addEventListener('fullscreenchange', refitAll);
        document.addEventListener('webkitfullscreenchange', refitAll);
      })
      .catch(err => {
        console.error('[SEQUENCE ERR]', err);
        if (loading) loading.textContent = 'Error: ' + (err?.message || err);
      });
  </script>
</Layout>
