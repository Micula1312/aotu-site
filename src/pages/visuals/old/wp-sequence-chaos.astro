---
import Layout from '../../layouts/VisualsLayout.astro';

const title = 'Visuals — WP Sequence (Chaos Collage)';
const current = 'visuals-chaos';
---

<Layout {title} {current}>
  <style slot="head">
    html, body { margin:0; height:100%; background:#000; color:#00ffc8; }
    body { overflow:hidden; font:12px ui-monospace,Menlo,Consolas,monospace; }
    .stage { position:fixed; inset:0; background:#000; }
    .shot { position:absolute; will-change:left, top, transform; }
    .shot .inner{ transform: rotate(var(--rot,0deg)); transform-origin:center; }
    .shot .inner > img.vimg{
      display:block; width:var(--wpx); height:var(--hpx);
      object-fit:contain; filter:blur(var(--fx-blur));
      max-width: var(--capvw, 20vw);
      max-height: var(--capvh, 20vh);
      box-shadow: 0 10px 40px rgba(0,0,0,.55);
    }
    .fx-pixelate .shot { transform: scale(calc(1 / var(--fx-px))); transform-origin: top left; }
    .fx-pixelate .shot .inner > img.vimg { transform: scale(var(--fx-px)); transform-origin: top left; image-rendering: pixelated; }

    .hud { position:fixed; left:12px; right:12px; bottom:8px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; pointer-events:none; }
    .hud .pill { pointer-events:auto; padding:6px 10px; border:1px solid rgba(0,255,200,.35); border-radius:999px; background:rgba(0,0,0,.45); color:#00ffc8; }
    .loading { position:fixed; left:12px; bottom:42px; color:#00ffc8; opacity:.75 }
    :is(:fullscreen, :-webkit-full-screen) .hud { opacity:0; pointer-events:none; }
  </style>

  <div id="stage" class="stage" aria-live="polite"></div>
  <div id="loading" class="loading">Loading…</div>

  <div class="hud">
    <span class="pill">F / dbl-click: fullscreen</span>
    <span class="pill">Space: play/pause</span>
    <span class="pill">R: reshuffle</span>
    <span class="pill">X: clear</span>
    <span class="pill">+ / −: speed</span>
    <span class="pill">[ / ]: size</span>
    <span class="pill">← / →: prev / next (in pausa)</span>
    <span class="pill" id="hudStat">—</span>
  </div>

  <script type="module">
    // Params
    const P = new URLSearchParams(location.search);
    const site    = (P.get('site') || 'https://thearchiveoftheuntamed.xyz/wp').replace(/\/$/, '');
    const perPage = Math.max(1, parseInt(P.get('perPage') || '60', 10));
    const orderby = P.get('orderby') || 'date';
    const order   = P.get('order')   || 'desc';
    const search  = P.get('search')  || '';

    let   every   = Math.max(200, parseInt(P.get('every') || '900', 10));
    let   SCALE   = Math.min(1, Math.max(0.12, parseFloat(P.get('scale') || '0.27')));
    const seed    = Math.max(0, parseInt(P.get('seed') || '5', 10));
    const nMax    = Math.max(1, parseInt(P.get('max')  || '220', 10));
    const tiltDeg = Math.max(0, parseInt(P.get('tilt') || '14', 10));

    // cap % viewport
    const cap  = Math.min(90, Math.max(5, parseInt(P.get('cap')  || '20', 10)));
    const capH = Math.min(90, Math.max(5, parseInt(P.get('capH') || String(cap), 10)));
    document.documentElement.style.setProperty('--capvw', cap  + 'vw');
    document.documentElement.style.setProperty('--capvh', capH + 'vh');

    // DOM
    const stage = document.getElementById('stage');
    const loading = document.getElementById('loading');
    const hudStat = document.getElementById('hudStat');

    // Endpoint
    const ep = new URL(site + '/wp-json/wp/v2/media');
    ep.searchParams.set('per_page', String(perPage));
    ep.searchParams.set('orderby', orderby);
    ep.searchParams.set('order',   order);
    ep.searchParams.set('media_type', 'image');
    ep.searchParams.set('_fields', 'id,source_url,media_details,alt_text');
    if (search) ep.searchParams.set('search', search);
    console.debug('[WP API]', ep.toString());

    const shuffle = (a)=>{ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
    const clamp = (v,min,max)=> Math.min(max, Math.max(min, v));

    const sizeFor = (nw, nh) => {
      const capWpx = Math.floor(innerWidth  * (cap  / 100));
      const capHpx = Math.floor(innerHeight * (capH / 100));
      const maxW = Math.min(Math.max(140, Math.floor(innerWidth  * SCALE)), capWpx);
      const maxH = Math.min(Math.max(140, Math.floor(innerHeight * SCALE)), capHpx);
      const r = Math.min(maxW/nw, maxH/nh, 1);
      return { w: Math.round(nw*r), h: Math.round(nh*r) };
    };

    let z = 1;
    function place(it){
      const nw = it.media_details?.width  || 1024;
      const nh = it.media_details?.height || 768;
      const { w, h } = sizeFor(nw, nh);
      const pad = 16;
      const x = Math.floor(Math.random() * Math.max(1, innerWidth  - w - pad)) + (pad/2);
      const y = Math.floor(Math.random() * Math.max(1, innerHeight - h - pad)) + (pad/2);
      const rot = (Math.random()*2 - 1) * tiltDeg;

      const wrap = document.createElement('div');
      wrap.className = 'shot';
      wrap.style.left = x + 'px';
      wrap.style.top  = y + 'px';
      wrap.style.zIndex = String(++z);
      wrap.style.setProperty('--wpx', w+'px');
      wrap.style.setProperty('--hpx', h+'px');
      wrap.dataset.nw = String(nw);
      wrap.dataset.nh = String(nh);

      const inner = document.createElement('div');
      inner.className = 'inner';
      inner.style.setProperty('--rot', rot.toFixed(2)+'deg');

      const img = new Image();
      img.className = 'vimg';
      img.decoding = 'async';
      img.loading  = 'eager';
      img.alt = it.alt_text || '';
      img.src = it.source_url;

      inner.appendChild(img);
      wrap.appendChild(inner);
      stage?.appendChild(wrap);
      if (stage && stage.children.length > nMax) stage.removeChild(stage.firstElementChild);

      return wrap;
    }

    function refitAll(){
      if (!stage) return;
      for (const el of stage.children){
        const wrap = /** @type {HTMLElement} */(el);
        const nw = parseInt(wrap.dataset.nw || '1024', 10);
        const nh = parseInt(wrap.dataset.nh || '768', 10);
        const { w, h } = sizeFor(nw, nh);
        wrap.style.setProperty('--wpx', w+'px');
        wrap.style.setProperty('--hpx', h+'px');
        const nx = clamp(parseInt(wrap.style.left||'0',10), 0, Math.max(0, innerWidth  - w));
        const ny = clamp(parseInt(wrap.style.top ||'0',10), 0, Math.max(0, innerHeight - h));
        wrap.style.left = nx + 'px'; wrap.style.top = ny + 'px';
      }
    }

    // Fullscreen
    const fsEl = () => document.fullscreenElement || document.webkitFullscreenElement;
    const enterFS = el => (el.requestFullscreen || el.webkitRequestFullscreen)?.call(el);
    const exitFS  = () => (document.exitFullscreen || document.webkitExitFullscreen)?.call(document);
    const toggleFS= () => { const t = stage || document.documentElement; if (!fsEl()) enterFS(t); else exitFS(); };
    stage?.addEventListener('dblclick', () => toggleFS());

    // Main
    fetch(ep.toString(), { cache:'no-store' })
      .then(r => { if(!r.ok) throw new Error('WP ' + r.status); return r.json(); })
      .then(items => {
        if (!Array.isArray(items) || items.length === 0) throw new Error('Nessuna immagine');
        let seq = shuffle(items.slice()), idx = 0, paused = false, timer = null, stack = [];

        for (let k=0;k<Math.min(20, seed);k++){ const el = place(seq[idx % seq.length]); stack.push(el); idx++; }
        loading?.remove();

        const updateHud = ()=> hudStat && (hudStat.textContent = `items ${stack.length}/${nMax} · seq ${(idx % seq.length)||seq.length}/${seq.length} · every ${every}ms · scale ${(SCALE*100)|0}% · cap ${cap}%`);
        const step = ()=>{ if (paused) return; const el = place(seq[idx % seq.length]); stack.push(el); idx++; updateHud(); };
        const play = ()=>{ stop(); timer = setInterval(step, every); };
        const stop = ()=>{ if (timer) clearInterval(timer); timer=null; };

        play(); updateHud();

        addEventListener('keydown', (e)=>{
          if (e.repeat) return;
          const k = e.key;
          if (k===' ') { paused=!paused; if (paused) stop(); else { step(); play(); } }
          else if (k==='r'||k==='R') { seq = shuffle(items.slice()); idx=0; }
          else if (k==='x'||k==='X') { stage && (stage.innerHTML=''); stack.length=0; }
          else if (k==='+') { every = Math.max(100, every-100); play(); updateHud(); }
          else if (k==='-') { every = every+100; play(); updateHud(); }
          else if (k==='[') { SCALE = Math.max(0.10, +(SCALE-0.05).toFixed(2)); refitAll(); updateHud(); }
          else if (k===']') { SCALE = Math.min(1.00, +(SCALE+0.05).toFixed(2)); refitAll(); updateHud(); }
          else if (k==='ArrowRight' || k=== '.') { /* step manuale */ if (paused) { step(); } }
          else if (k==='ArrowLeft'  || k=== ',') { /* undo */ if (paused && stack.length) { const last = stack.pop(); last?.remove(); updateHud(); } }
          else if (k==='f'||k==='F') { toggleFS(); }
          else if (k==='Escape') { exitFS(); }
        });

        addEventListener('resize', refitAll);
        document.addEventListener('fullscreenchange', refitAll);
        document.addEventListener('webkitfullscreenchange', refitAll);
      })
      .catch(err => { console.error('[CHAOS ERR]', err); loading && (loading.textContent = 'Error: ' + (err?.message||err)); });
  </script>
</Layout>
