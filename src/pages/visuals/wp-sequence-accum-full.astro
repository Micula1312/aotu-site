---
import P5Canvas from "../../components/P5Canvas.astro";
import type { ImgItem } from "../../scripts/visuals/sketch-types";
import { buildMediaURL } from "./helpers/wp-media";

const url = new URL(Astro.request.url);
const site = url.searchParams.get('site') ?? 'https://thearchiveoftheuntamed.xyz/wp';

const q = {
  per_page: Number(url.searchParams.get('perPage') ?? 48),
  orderby: url.searchParams.get('orderby') ?? 'date',
  order: url.searchParams.get('order') ?? 'desc',
  media_type: 'image', // ðŸ”’ solo immagini
  // filtri opzionali
  search: url.searchParams.get('search') ?? undefined,
  author: url.searchParams.get('author') ?? undefined,
  mime_type: url.searchParams.get('mime_type') ?? undefined,
  media_tag: url.searchParams.get('media_tag') ?? undefined,
  media_category: url.searchParams.get('media_category') ?? undefined,
  after: url.searchParams.get('after') ?? undefined,
  before: url.searchParams.get('before') ?? undefined,
};

const interval = Number(url.searchParams.get('interval') ?? 1200);
const scale = Number(url.searchParams.get('scale') ?? 0.5);

const mediaRes = await fetch(buildMediaURL(site, q));
const media = (await mediaRes.json()) as any[];

// 1) prendi l'URL migliore disponibile dalla risposta WP
function pickBestUrl(m: any): string | undefined {
  const sizes = m?.media_details?.sizes ?? {};
  const pref = ['large', 'medium_large', 'medium', 'full', 'thumbnail'];
  for (const key of pref) {
    const maybe = sizes?.[key]?.source_url;
    if (typeof maybe === 'string' && maybe) return maybe;
  }
  if (typeof m?.source_url === 'string' && m.source_url) return m.source_url;
  if (typeof m?.guid?.rendered === 'string' && m.guid.rendered) return m.guid.rendered;
  return undefined;
}

// 2) assicurati che sia ASSOLUTO (supporta anche path relativi tipo "/wp-content/..."),
//    altrimenti /api/img riceve roba invalida e risponde 400
function toAbs(u: string | undefined): string | undefined {
  if (!u || !u.trim()) return undefined;
  try {
    // se Ã¨ giÃ  assoluto (http/https) torna cosÃ¬ comâ€™Ã¨
    const abs = new URL(u);
    return abs.toString();
  } catch {
    try {
      // rendilo assoluto rispetto al sito WP scelto
      const abs = new URL(u, site);
      return abs.toString();
    } catch {
      return undefined;
    }
  }
}

// 3) scarta qualsiasi cosa non http/https
function isHttpUrl(u: string | undefined): u is string {
  if (!u) return false;
  try {
    const parsed = new URL(u);
    return parsed.protocol === 'http:' || parsed.protocol === 'https:';
  } catch {
    return false;
  }
}

const prox = (u: string) => `/api/img?src=${encodeURIComponent(u)}`;

const images: ImgItem[] = media
  .filter((m) => m?.media_type === 'image' || m?.mime_type?.startsWith?.('image/'))
  .map((m) => pickBestUrl(m))
  .map((u) => toAbs(u))
  .filter(isHttpUrl)
  .map((u, idx) => ({ id: idx, src: prox(u), title: '' }));

console.log('[sequence-accum] images.count =', images.length, images.slice(0, 2));

const sketchPath = "/src/scripts/visuals/image-accumulator.ts";
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AOTU â€” WP Sequence Accumulator</title>
    <style>html,body{height:100%;margin:0} body{background:#000;}</style>
  </head>
  <body>
    <P5Canvas sketchPath={sketchPath} props={{ images, interval, scale }} />
  </body>
</html>
