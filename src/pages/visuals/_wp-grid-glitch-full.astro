---
import P5Canvas from "../../components/P5Canvas.astro";
import VisualUI from "../../components/visualUI.astro";
import type { ImgItem } from "../../scripts/visuals/sketch-types";
import { buildMediaURL } from "./helpers/wp-media";

const url = new URL(Astro.request.url);
const site = url.searchParams.get('site') ?? 'https://thearchiveoftheuntamed.xyz/wp';
const q = {
  per_page: Number(url.searchParams.get('perPage') ?? 48),
  orderby: url.searchParams.get('orderby') ?? 'date',
  order: url.searchParams.get('order') ?? 'desc',
  search: url.searchParams.get('search') ?? undefined,
  author: url.searchParams.get('author') ?? undefined,
  mime_type: url.searchParams.get('mime_type') ?? undefined,
  media_tag: url.searchParams.get('media_tag') ?? undefined,
  media_category: url.searchParams.get('media_category') ?? undefined,
  after: url.searchParams.get('after') ?? undefined,
  before: url.searchParams.get('before') ?? undefined,
};
const cols = Number(url.searchParams.get('cols') ?? 6);
const rows = Number(url.searchParams.get('rows') ?? 4);
const glitchEvery = Number(url.searchParams.get('glitchEvery') ?? 350);

const mediaRes = await fetch(buildMediaURL(site, q));
const media = (await mediaRes.json()) as any[];
const images: ImgItem[] = media.map(m => ({
  id: m.id,
  src: m.media_details?.sizes?.large?.source_url || m.media_details?.sizes?.medium?.source_url || m.source_url,
  title: m.title?.rendered
}));

const sketchPath = "/src/scripts/visuals/grid-glitch.ts";
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AOTU â€” Grid Glitch (Full)</title>
    <style>html,body{height:100%;margin:0} body{background:#000;overflow:hidden}</style>
  </head>
  <body>
    <P5Canvas ui sketchPath={sketchPath} props={{ images, cols, rows, glitchEvery }}>
      <Fragment slot="ui"><VisualUI /></Fragment>
    </P5Canvas>
  </body>
</html>
