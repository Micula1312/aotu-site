---
/* Sidebar.astro — versione robusta con BASE + URL builder */
const { current = '' } = Astro.props;

/** BASE gestisce eventuale sottocartella in produzione (es. /aotu/) */
const BASE = (import.meta.env.BASE_URL ?? '/') as string;

/** Prefissa il BASE e normalizza gli slash */
const link = (p: string) => BASE + p.replace(/^\//, '');

/** Query di default per i template Visuals: override con secondo argomento */
function buildQS(over: Record<string, string | number | undefined> = {}) {
  const base: Record<string, string> = {
    site: 'https://thearchiveoftheuntamed.xyz/wp',
    perPage: '60',
    orderby: 'date',
    order: 'desc',
  };
  for (const [k, v] of Object.entries(over)) {
    if (v === undefined || v === null || String(v).trim() === '') delete base[k];
    else base[k] = String(v);
  }
  const q = new URLSearchParams(base);
  return `?${q.toString()}`;
}
---

<!-- Backdrop per il drawer mobile -->
<div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true"></div>

<!-- Tab mobile per aprire la sidebar “a caduta” -->
<button
  id="sidebarPull"
  class="sidebar-pull mobile-only"
  aria-controls="sidebar"
  aria-expanded="true"
  type="button"
>
  INDEX ▾
</button>

<!-- Sidebar (desktop sticky / mobile drop-down) -->
<aside id="sidebar" class="index" tabindex="-1" aria-label="Site navigation">
  <!-- Barra titolo + controlli finestra -->
  <div class="winbar">
    <h2 class="title">AOTU · Index</h2>
    <div class="btns">
      <button id="toggleSidebarDesktop" class="btn small desktop-only" aria-expanded="true" type="button">◀ collapse</button>
      <button id="closeSidebar" class="btn small mobile-only" type="button" aria-label="Close sidebar">close ✕</button>
    </div>
  </div>

  <!-- maniglia che appare sulla rail quando collassato (desktop) -->
  <button id="railHandle" class="rail-handle desktop-only" title="Expand sidebar" aria-expanded="false">☰</button>

  <!-- NAV a cassetti -->
  <nav class="index-list">

    <!-- Gruppo: Tools -->
    <details class="drawer" data-drawer="pages" open>
      <summary>Tools</summary>
      <ul>
        <li class={current==='archive' ? 'is-active' : ''}><a href={link('/')}                data-nav="hard">Mediarchive</a></li>
        <li class={current==='network' ? 'is-active' : ''}><a href={link('/network/')}       data-nav="hard">Network</a></li>
        <li class={current==='texts'   ? 'is-active' : ''}><a href={link('/texts/')}         data-nav="hard">Bibliography</a></li>
        <li class={current==='p5'      ? 'is-active' : ''}><a href={link('/lab/p5-experiments/')} data-nav="hard">P5 Lab</a></li>
      </ul>
    </details>

    <!-- Gruppo: Pages -->
    <details class="drawer" data-drawer="tools">
      <summary>Pages</summary>
      <ul>
        <li class={current==='abstract'  ? 'is-active' : ''}><a href={link('/abstract/')}   data-nav="hard">About</a></li>
        <li class={current==='manifesto' ? 'is-active' : ''}><a href={link('/manifesto/')}  data-nav="hard">Manifesto</a></li>
      </ul>
    </details>

    <!-- Gruppo: Visuals (solo le route presenti) -->
    <details class="drawer" data-drawer="visuals" open>
      <summary>Visuals</summary>
      <ul>
        <!-- Sequence Accum -->
        <li class={current==='visuals-seq' ? 'is-active' : ''}>
          <a href={link('/visuals/wp-sequence-accum') + buildQS({ perPage: 60, scale: 0.5, interval: 1200 })} data-nav="hard">
            Sequence (accum)
          </a>
        </li>
        <li class={current==='visuals-seq-full' ? 'is-active' : ''}>
          <a href={link('/visuals/wp-sequence-accum-full') + buildQS({ perPage: 60, scale: 0.55, interval: 1100 })} data-nav="hard">
            Sequence (accum · full UI)
          </a>
        </li>

        <!-- Grid Glitch -->
        <li class={current==='visuals-grid' ? 'is-active' : ''}>
          <a href={link('/visuals/wp-grid-glitch') + buildQS({ perPage: 48, cols: 6, rows: 4, glitchEvery: 350 })} data-nav="hard">
            Grid (glitch)
          </a>
        </li>
        <li class={current==='visuals-grid-full' ? 'is-active' : ''}>
          <a href={link('/visuals/wp-grid-glitch-full') + buildQS({ perPage: 48, cols: 6, rows: 4, glitchEvery: 350 })} data-nav="hard">
            Grid (glitch · full UI)
          </a>
        </li>

        <!-- Ribbon Flowfield (non usa WP: rimuovo il param "site") -->
        <li class={current==='visuals-ribbon' ? 'is-active' : ''}>
          <a href={link('/visuals/ribbon-flowfield') + buildQS({ site: undefined, count: 300, speed: 1.6, noiseScale: 0.0016 })} data-nav="hard">
            Ribbon Flowfield
          </a>
        </li>
        <li class={current==='visuals-ribbon-full' ? 'is-active' : ''}>
          <a href={link('/visuals/ribbon-flowfield-full') + buildQS({ site: undefined, count: 300, speed: 1.6, noiseScale: 0.0016 })} data-nav="hard">
            Ribbon Flowfield (full UI)
          </a>
        </li>
      </ul>
    </details>



  </nav>

  <!-- Controlli -->
  <div class="controls" style="display:grid; gap:8px; margin-top:12px;">
    <button id="themeBtn" class="btn">terminal</button>
    <button id="audioBtn" class="btn">[ mute ]</button>
    <button id="neonBtn"  class="btn" aria-pressed="false" title="Neon mode">★ neon</button>
  </div>
</aside>
