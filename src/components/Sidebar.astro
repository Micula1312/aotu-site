---
/* Sidebar.astro — Visuals: Slideshow + Mosaic • poi Machine Reader */
const { current = '' } = Astro.props;

/** BASE gestisce eventuale sottocartella in produzione (es. /aotu/) */
const BASE = (import.meta.env.BASE_URL ?? '/') as string;

/** Prefissa il BASE e normalizza gli slash */
const link = (p: string) => BASE + p.replace(/^\//, '');

/** Query di default per i template Visuals: override con secondo argomento */
function buildQS(over: Record<string, string | number | undefined> = {}) {
  const base: Record<string, string> = {
    site: 'https://thearchiveoftheuntamed.xyz/wp',
    perPage: '100',
    orderby: 'date',
    order: 'desc',
  };
  for (const [k, v] of Object.entries(over)) {
    if (v === undefined || v === null || String(v).trim() === '') delete base[k];
    else base[k] = String(v);
  }
  const q = new URLSearchParams(base);
  return `?${q.toString()}`;
}
---

<!-- Backdrop per il drawer mobile -->
<div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true"></div>

<!-- Tab mobile per aprire la sidebar “a caduta” -->
<button
  id="sidebarPull"
  class="sidebar-pull mobile-only"
  aria-controls="sidebar"
  aria-expanded="true"
  type="button"
>
  INDEX ▾
</button>

<!-- Sidebar (desktop sticky / mobile drop-down) -->
<aside id="sidebar" class="index" tabindex="-1" aria-label="Site navigation">
  <!-- Barra titolo + controlli finestra -->
  <div class="winbar">
    <h2 class="title">AOTU · Index</h2>
    <div class="btns">
      <button id="toggleSidebarDesktop" class="btn small desktop-only" aria-expanded="true" type="button">◀ </button>
      <button id="closeSidebar" class="btn small mobile-only" type="button" aria-label="Close sidebar">✕</button>
    </div>
  </div>

  <!-- maniglia che appare sulla rail quando collassato (desktop) -->
  <button id="railHandle" class="rail-handle desktop-only" title="Expand sidebar" aria-expanded="false">☰</button>

  <!-- NAV a cassetti -->
  <nav class="index-list">

    <!-- Gruppo: Tools (immutato) -->
    <details class="drawer" data-drawer="pages" open>
      <summary>Archive</summary>
      <ul>
        <li class={current==='archive' ? 'is-active' : ''}><a href={link('/')}                data-nav="hard">Mediarchive</a></li>
        <!-- <li class={current==='network' ? 'is-active' : ''}><a href={link('/network/')}       data-nav="hard">Network</a></li>
        <li class={current==='texts'   ? 'is-active' : ''}><a href={link('/texts/')}         data-nav="hard">Bibliography</a></li> -->
        <!-- <li class={current==='p5'      ? 'is-active' : ''}><a href={link('/lab/p5-experiments/')} data-nav="hard">P5 Lab</a></li> -->
      </ul>
    </details>

    <!-- Gruppo: Pages (immutato) -->
    <details class="drawer" data-drawer="tools">
      <summary>About</summary>
      <ul>
        <li class={current==='abstract'  ? 'is-active' : ''}><a href={link('/abstract/')}   data-nav="hard">About</a></li>
        <li class={current==='manifesto' ? 'is-active' : ''}><a href={link('/manifesto/')}  data-nav="hard">Manifesto</a></li>
      </ul>
    </details>

    <!-- Gruppo: Visuals (SOLO i due template di oggi) -->
    <details class="drawer" data-drawer="visuals" open>
      <summary>Visuals</summary>
      <ul>
        <li class={current==='visuals-slideshow' ? 'is-active' : ''}>
          <a
            href={link('/visuals/slideshow') + buildQS({
              perPage: 100, delay: 1800, shuffle: 1, fit: 'cover'
            })}
            data-nav="hard"
          >
            Slideshow
          </a>
        </li>
        <li class={current==='visuals-mosaic' ? 'is-active' : ''}>
          <a
            href={link('/visuals/mosaic') + buildQS({
              perPage: 100, speed: 2, dwell: 1400, cell: 16, order: 'center', fit: 'cover', shuffle: 1
            })}
            data-nav="hard"
          >
            Mosaic
          </a>
        </li>
      </ul>
    </details>

    <!-- Ultima voce: Machine Reader -->
    <!-- <details class="drawer" data-drawer="machine" open>
      <summary>Machine</summary>
      <ul>
        <li class={current==='machine-reader' ? 'is-active' : ''}>
          <a href={link('/machine-reader/')} data-nav="hard">Machine Reader</a>
        </li>
      </ul>
    </details> -->

  </nav>

  <!-- Controlli -->
  <div class="controls" style="display:grid; gap:8px; margin-top:12px;">
    <button id="audioBtn" class="btn">[ play ♩ ]</button>
    <button id="themeBtn" class="btn">terminal</button>
    
    <button id="neonBtn"  class="btn" aria-pressed="false" title="Neon mode">★ neon</button>
  </div>
</aside>
